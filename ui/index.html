<!DOCTYPE html>
<meta charset="UTF-8">
<head>
<title>Emotiv EEG Visualizer</title>
    <link type="text/css" rel="stylesheet" href="css/graph.css">
    <link type="text/css" rel="stylesheet" href="css/detail.css">
    <link type="text/css" rel="stylesheet" href="css/legend.css">
    <link type="text/css" rel="stylesheet" href="css/extensions.css">

    <script src="vendor/d3.v2.js"></script>

    <script src="js/Rickshaw.js"></script>
    <script src="js/Rickshaw.Class.js"></script>
    <script src="js/Rickshaw.Compat.ClassList.js"></script>
    <script src="js/Rickshaw.Graph.js"></script>
    <script src="js/Rickshaw.Graph.Renderer.js"></script>
    <script src="js/Rickshaw.Graph.Renderer.Stack.js"></script>
    <script src="js/Rickshaw.Graph.Renderer.Line.js"></script>
    <script src="js/Rickshaw.Graph.Renderer.Area.js"></script>
    <script src="js/Rickshaw.Graph.RangeSlider.js"></script>
    <script src="js/Rickshaw.Graph.HoverDetail.js"></script>
    <script src="js/Rickshaw.Graph.Annotate.js"></script>
    <script src="js/Rickshaw.Graph.Legend.js"></script>
    <script src="js/Rickshaw.Graph.Axis.Time.js"></script>
    <script src="js/Rickshaw.Graph.Behavior.Series.Toggle.js"></script>
    <script src="js/Rickshaw.Graph.Behavior.Series.Order.js"></script>
    <script src="js/Rickshaw.Graph.Behavior.Series.Highlight.js"></script>
    <script src="js/Rickshaw.Graph.Smoother.js"></script>
    <script src="js/Rickshaw.Graph.Unstacker.js"></script>
    <script src="js/Rickshaw.Fixtures.Time.js"></script>
    <script src="js/Rickshaw.Fixtures.RandomData.js"></script>
    <script src="js/Rickshaw.Fixtures.Color.js"></script>
    <script src="js/Rickshaw.Color.Palette.js"></script>
    <script src="js/Rickshaw.Series.js"></script>
    <script src="js/Rickshaw.Series.FixedDuration.js"></script>
    <script src="rickshaw.js"></script>

    <style>
    #chart {
        position: relative;
        display: inline-block;
        left: 40px;
    }

    #y_axis {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40px;
    }
    #legend {
        display: inline-block;
        vertical-align: top;
        margin: 0 0 0 10px;
    }

    body {
        background-image:url('images/logo_emotiv.jpg');
        background-repeat:no-repeat;
        background-position:right top;
    }
    </style>
</head>
<body>
    <div id="content">
        <table>
            <tr>
                <td width="1200">
                    <div id="y_axis"></div>
                    <div id="chart"></div>
                </td>
                <td>
                    <div id="legend"></div>
                </td>

            </tr>
    </table>

    </div>
    

    <script>
        /* Websocket */
        var sock = null;
        /* Log */
        var ellog = null;
        var wsuri = "ws://localhost:9000";

        function change_address()
        {
            var address = document.getElementById("wsuri");
            if(address.value.length != 0)
            {
                wsuri = address.value;
            }
            
            if (sock != null)
            {
                sock.close();
            }

            draw();
        }

        function draw()
        {
            ellog = document.getElementById('log');

            if ("WebSocket" in window) 
            {
                sock = new WebSocket(wsuri);
            } 
            else if ("MozWebSocket" in window) 
            {
                sock = new MozWebSocket(wsuri);
            } 
            else 
            {
                log("Browser does not support WebSocket!");
                window.location = "http://autobahn.ws/unsupportedbrowser";
            }

            var Channels;
            var gArray = new Array();
            var palette = new Rickshaw.Color.Palette( { scheme: 'classic9' } );
            var ch_names = ['AF3', 'F7', 'F3', 'FC5',
                    'T7', 'P7', 'O1', 'O2',
                    'P8', 'T8', 'FC6', 'F4',
                    'F8', 'AF4']
            if (sock)
            {
                sock.onopen = function()
                {
                    log("Connected to " + wsuri);

                    document.getElementById("change").style.display = "none";
                    document.getElementById("specify").style.display = "none";
                    document.getElementById("wsuri").style.display = "none";

                    for(var i = 0; i < 14; i++)
                    {
                        var graph = new Rickshaw.Graph({
                            element: document.getElementById("chart"),
                            width: 1000,
                            height: 75,
                            renderer: 'line',
                            series: new Rickshaw.Series.FixedDuration([{ name: ch_names[i], color:palette.color()  }], undefined,
                            {
                                timeInterval: 1000,
                                maxDataPoints: 50,
                            })
                        });
                        graph.configure({strokeWidth:1});
                        var xTick = new Rickshaw.Graph.Axis.Time( { graph: graph } );
                        // var yTick = new Rickshaw.Graph.Axis.Y(
                        //     {
                        //         graph: graph,
                        //         orientation: 'left',
                        //         tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
                        //         element: document.getElementById('y_axis'),
                        //     } );
                        var legend = new Rickshaw.Graph.Legend( {
                            element: document.querySelector('#legend'),
                            graph: graph
                        } );
                        graph.render()
                        gArray.push(graph);
                    } 
                }

                sock.onclose = function(e)
                {
                    log("Connection closed (wasClean = " + e.wasClean + 
                                            ", code = " + e.code + 
                                            ", reason = '" + e.reason + "')");
                    sock = null;
                }

                sock.onmessage = function(msg) 
                {
                    var text = msg.data;
                    Channels = eval ("(" + text + ")");

                    var iv = setInterval( function()
                    {   
                        for (i=0 ; i<14; i++)
                        {
                            var data = { signal: Channels.channels[i].signal, color:palette.color() };
                            gArray[i].series.addData(data);
                            gArray[i].render();
                        }
                    });

                    //log(ch_obj.channels.length);
                    //log(obj);

                    // for(i=0; i<Channels.channels.length; i++)
                    //     log("Channel: " + Channels.channels[i].channel +
                    //         "\nSignal: " + Channels.channels[i].signal +
                    //         "\nQuality: " + Channels.channels[i].quality);
                    //log(ch + ": Signal: " + ch.signal + " Quality: " + ch.quality);
                }
            }
        }

        /* Log */
        function log(m)
        {
            ellog.innerHTML += m + '\n';
            ellog.scrollTop = ellog.scrollHeight;
        };

    </script>

    <div id="specify"> Please specify the address: </div>
    <input type="text" id="wsuri" placeholder="ws://localhost:9000">
    <button id="change" onclick="change_address()"> Change </button>

    <noscript>You must enable JavaScript</noscript>
    <pre id="log" style="height: 10em; overflow-y: scroll; background-color: #faa;">
    </pre>

    <div style="height:0px;width:0px;overflow:hidden;"></div>
</body>
</html>
